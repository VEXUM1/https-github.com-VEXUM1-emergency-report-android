<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>緊急通報</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f0f0; text-align: center; font-family: sans-serif; }
        #reportButton { font-size: 24px; padding: 20px 40px; cursor: pointer; border-radius: 10px; border: none; background-color: #d9534f; color: white; margin-top: 10px; }
        #reportButton:disabled { background-color: #999; }
        #userInfo { font-size: 16px; color: #333; }
        #changeIdLink { font-size: 14px; color: #007bff; cursor: pointer; text-decoration: underline; margin-top: 20px; }
        /* ★★★ 状況表示メッセージ用のスタイルを追加 ★★★ */
        #statusMessage { font-size: 18px; font-weight: bold; min-height: 27px; }
        .status-sending { color: #007bff; } /* 通報中：青 */
        .status-success { color: #28a745; } /* 成功：緑 */
        .status-error { color: #dc3545; }   /* 失敗：赤 */
    </style>
</head>
<body>
    <p id="userInfo"></p>
    <button id="reportButton">緊急通報</button>
    <a id="changeIdLink">IDを変更する</a>
    <p id="statusMessage"></p>

    <script>
        // ★★★ あなたの会社のGASのURLを貼り付けてください ★★★
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxbigRQW9Fh4y7Bv-OEhGtcgufR8BGm_9RvODgTkZKxwJJ2EUEr613vb7QscX7Hr_YG/exec';

        const reportButton = document.getElementById('reportButton');
        const userInfoDisplay = document.getElementById('userInfo');
        const changeIdLink = document.getElementById('changeIdLink');
        const statusMessage = document.getElementById('statusMessage'); // ★★★ 状況表示用の要素を取得 ★★★

        function setupUser() {
            let userId = localStorage.getItem('emergencyReportUserID');
            if (!userId) {
                userId = prompt("【初回登録】\n職員IDを入力してください。\n（例：1001）");
                if (userId) {
                    localStorage.setItem('emergencyReportUserID', userId);
                    alert(`ID「${userId}」を登録しました。\n次回から自動でこのIDが使用されます。`);
                } else {
                    alert("IDが未入力のため通報できません。");
                    reportButton.disabled = true;
                    return;
                }
            }
            userInfoDisplay.textContent = `通報者ID: ${userId}`;
        }

        // ★★★ ボタンが押された後の動作を大幅に修正 ★★★
        reportButton.addEventListener('click', () => {
            const userId = localStorage.getItem('emergencyReportUserID');
            if (!userId) {
                statusMessage.className = 'status-error';
                statusMessage.textContent = 'IDが未登録です。再読み込みしてください。';
                return;
            }

            // ボタンを無効化し、メッセージを表示
            reportButton.disabled = true;
            statusMessage.className = 'status-sending';
            statusMessage.textContent = '通報中...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const postData = { userId: userId, lat: lat, lon: lon };

                    fetch(GAS_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(postData)
                    })
                    .then(response => {
                        statusMessage.className = 'status-success';
                        statusMessage.textContent = '通報が完了しました。';
                    })
                    .catch(error => {
                        statusMessage.className = 'status-error';
                        statusMessage.textContent = '通報に失敗しました。';
                        reportButton.disabled = false; // エラー時は再度押せるようにする
                    });
                },
                (error) => {
                    statusMessage.className = 'status-error';
                    statusMessage.textContent = '位置情報の取得に失敗しました。';
                    reportButton.disabled = false; // エラー時は再度押せるようにする
                }
            );
        });
        
        changeIdLink.addEventListener('click', () => {
            if (reportButton.disabled) return; // 通報中はID変更不可
            if (confirm("IDをリセットして再登録しますか？")) {
                localStorage.removeItem('emergencyReportUserID');
                alert("IDをリセットしました。ページを再読み込みします。");
                window.location.reload();
            }
        });

        setupUser();
    </script>
</body>
</html>